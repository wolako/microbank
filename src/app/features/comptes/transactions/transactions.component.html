<!-- transactions.component.html -->
<div class="transactions-container container mt-4">
  <h2 class="mb-4">üí≥ Effectuer une transaction</h2>

  <form [formGroup]="transactionsForm" (ngSubmit)="submit()" class="needs-validation" novalidate>

    <!-- Type de transaction -->
    <div class="mb-3">
      <label for="type" class="form-label">Type de transaction</label>
      <select id="type" formControlName="type" class="form-select" required>
        <option value="deposit_manual">D√©p√¥t manuel</option>
        <option value="deposit_mobile">D√©p√¥t Mobile Money</option>
        <option value="deposit_wire">D√©p√¥t par virement</option>
        <option value="deposit_card">D√©p√¥t carte bancaire</option>
        <option value="withdrawal_mobile">Retrait Mobile Money</option>
        <option value="withdrawal_card">Retrait carte bancaire</option>
        <option value="withdrawal_atm">Retrait guichet automatique</option>
        <option value="transfer">Transfert interne</option>
        <option value="wire">Virement externe</option>
        <option value="bill_payment">Paiement de facture</option>
        <option value="purchase">Achat en ligne</option>
      </select>
    </div>

    <!-- Montant -->
    <div class="mb-3">
      <label for="amount" class="form-label">Montant</label>
      <input type="number" id="amount" formControlName="amount" class="form-control" placeholder="0 FCFA" required />
    </div>

    <!-- Recipient / IBAN -->
    <div *ngIf="transactionsForm.get('type')?.value === 'transfer' || transactionsForm.get('type')?.value === 'wire'" class="mb-3">
      <label class="form-label">{{ labelForRecipient }}</label>
      <input type="text" formControlName="recipient" class="form-control" placeholder="Nom ou IBAN du destinataire" required />
    </div>

    <!-- D√©p√¥t Mobile Money -->
    <div *ngIf="transactionsForm.get('type')?.value === 'deposit_mobile'" class="mb-3">
      <label class="form-label">Num√©ro Mobile Money</label>
      <input type="tel" formControlName="mobileMoneyPhone" class="form-control" placeholder="Ex: 90XXXXXX" required />

      <label class="form-label mt-2">Choisir le r√©seau</label>
      <select formControlName="provider" class="form-select" required>
        <option value="">-- S√©lectionner --</option>
        <option value="FLOOZ">FLOOZ</option>
        <option value="T-MONEY">T-MONEY</option>
      </select>
    </div>

    <!-- Retrait Mobile Money -->
    <div *ngIf="transactionsForm.get('type')?.value === 'withdrawal_mobile'" class="mb-3">
      <label class="form-label">Num√©ro Mobile Money</label>
      <input type="tel" formControlName="mobileMoneyPhone" class="form-control" placeholder="Ex: 90XXXXXX" required />

      <label class="form-label mt-2">Choisir le r√©seau</label>
      <select formControlName="provider" class="form-select" required>
        <option value="FLOOZ">FLOOZ</option>
        <option value="T-MONEY">T-MONEY</option>
      </select>
    </div>

    <!-- D√©p√¥t / Retrait Carte -->
    <div *ngIf="transactionsForm.get('type')?.value === 'deposit_card' || transactionsForm.get('type')?.value === 'withdrawal_card'" class="mb-3">
      <label class="form-label">Num√©ro de carte</label>
      <input type="text" formControlName="cardNumber" class="form-control" placeholder="1234 5678 9012 3456" required />

      <label class="form-label mt-2">Expiration (MM/YY)</label>
      <input type="text" formControlName="cardExp" class="form-control" placeholder="MM/AA" required />

      <label class="form-label mt-2">CVV</label>
      <input type="text" formControlName="cardCvv" class="form-control" placeholder="123" required />
    </div>

    <!-- D√©p√¥t par virement -->
    <div *ngIf="transactionsForm.get('type')?.value === 'deposit_wire'" class="mb-3">
      <label class="form-label">IBAN</label>
      <input type="text" formControlName="iban" class="form-control" placeholder="FR76 XXXX XXXX XXXX XXXX XXXX XXX" required />

      <label class="form-label mt-2">Nom de la banque</label>
      <input type="text" formControlName="bankName" class="form-control" placeholder="Ex: Ecobank" required />
    </div>

    <!-- Retrait ATM -->
    <div *ngIf="transactionsForm.get('type')?.value === 'withdrawal_atm'" class="mb-3">
      <p class="text-info">üí° Un code de retrait temporaire sera g√©n√©r√© pour le guichet automatique.</p>
    </div>

    <!-- Paiement de facture -->
    <div *ngIf="transactionsForm.get('type')?.value === 'bill_payment'" class="mb-3">
      <label class="form-label">Type de facture</label>
      <select formControlName="billType" class="form-select" required>
        <option value="CANAL">Canal+</option>
        <option value="CANALBOX">CanalBox</option>
        <option value="CEET">√âlectricit√© (CEET)</option>
        <option value="SONEB">Eau (SONEB)</option>
      </select>

      <label class="form-label mt-2">Fournisseur</label>
      <input type="text" formControlName="billProvider" class="form-control" placeholder="Ex: CANAL, CEET..." required />

      <label class="form-label mt-2">R√©f√©rence client / carte / compteur</label>
      <input type="text" formControlName="billReference" class="form-control" placeholder="Ex: 123456789" required />
    </div>

    <!-- Achat en ligne -->
    <div *ngIf="transactionsForm.get('type')?.value === 'purchase'" class="mb-3">
      <label class="form-label">Marchand</label>
      <input type="text" formControlName="merchant" class="form-control" placeholder="Amazon, Cdiscount..." required />

      <label class="form-label mt-2">Produit</label>
      <input type="text" formControlName="product" class="form-control" placeholder="Nom du produit achet√©" required />

      <label class="form-label mt-2">R√©f√©rence de commande</label>
      <input type="text" formControlName="orderRef" class="form-control" placeholder="Ex: CMD123456" required />
    </div>

    <!-- Description -->
    <div class="mb-3">
      <label class="form-label">Description</label>
      <input type="text" formControlName="description" class="form-control" placeholder="Ex: Paiement facture Canal+" />
    </div>

    <!-- Bouton Valider -->
    <button type="submit" [disabled]="isLoading || transactionsForm.invalid" class="btn btn-primary w-100">
      {{ isLoading ? 'Chargement...' : 'Valider' }}
    </button>
  </form>

  <!-- Messages -->
  <div class="mt-3">
    <div *ngIf="successMessage" class="alert alert-success">{{ successMessage }}</div>
    <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>
  </div>

  <!-- Solde -->
  <p class="balance mt-3 fw-bold">üí∞ Solde actuel : {{ userBalance | number }} FCFA</p>

  <!-- Modal 2FA -->
  <app-two-fa-modal
    [visible]="show2FAModal"
    (onConfirm)="submit2FAToken($event)"
    (onCancel)="show2FAModal = false"
    [message]="'Veuillez entrer votre code 2FA pour valider la transaction.'">
  </app-two-fa-modal>

  <!-- Retrait ATM Modal -->
  <app-atm-code-modal
    [visible]="showATMCodeInput"
    (onConfirm)="submitATMCode($event)"
    (onCancel)="cancelATMCode()">
  </app-atm-code-modal>


</div>
